{
  "version": 3,
  "sources": ["src/app/services/gemini-ai.service.ts"],
  "sourcesContent": ["import { Injectable } from '@angular/core';\nimport { Observable, throwError, from } from 'rxjs';\nimport { catchError, map } from 'rxjs/operators';\nimport { GoogleGenAI } from '@google/genai';\nimport * as CryptoJS from 'crypto-js';\n\nexport interface GeminiRequest {\n  prompt: string;\n  temperature?: number;\n  maxTokens?: number;\n}\n\nexport interface ScenarioGenerationRequest {\n  genre?: string;\n  style?: string;\n  mood?: string;\n  additionalContext?: string;\n  isAdult?: boolean;\n}\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class GeminiAiService {\n  private readonly ENCRYPTED_API_KEY = 'U2FsdGVkX19ILCT33NvRMnrfGuGerBksJREzwCDAIb7VpwUoVn/Oc3vrAqfYplC8SjPFUU3npbu+85eFwOKgpw==';\n  private readonly ENCRYPTION_KEY = 'ezReader';\n  private apiKey = '';\n  private ai!: GoogleGenAI;\n\n  constructor() {\n    // API 키 초기화 (로컬 스토리지에서 커스텀 키가 있으면 사용)\n    this.initApiKey();\n    this.ai = new GoogleGenAI({ apiKey: this.apiKey });\n    console.log('GeminiAiService initialized with gemini-2.5-flash model');\n  }\n\n  private initApiKey(): void {\n    // 로컬 스토리지에 저장된 커스텀 API 키가 있으면 사용\n    const storedKey = localStorage.getItem('gemini_api_key');\n    if (storedKey) {\n      this.apiKey = storedKey;\n    } else {\n      // 암호화된 키를 복호화\n      try {\n        const decrypted = CryptoJS.AES.decrypt(this.ENCRYPTED_API_KEY, this.ENCRYPTION_KEY);\n        this.apiKey = decrypted.toString(CryptoJS.enc.Utf8);\n      } catch (error) {\n        console.error('API 키 복호화 실패:', error);\n        this.apiKey = '';\n      }\n    }\n  }\n\n  // API 키 설정\n  setApiKey(key: string): void {\n    this.apiKey = key;\n    localStorage.setItem('gemini_api_key', key);\n    // API 키 변경 시 GoogleGenAI 인스턴스 재생성\n    this.ai = new GoogleGenAI({ apiKey: this.apiKey });\n  }\n\n  // API 키 가져오기\n  getApiKey(): string {\n    return this.apiKey;\n  }\n\n  // API 키 존재 여부 확인\n  hasApiKey(): boolean {\n    return !!this.apiKey && this.apiKey.length > 0;\n  }\n\n  // 무협 시나리오 생성\n  generateScenario(request: ScenarioGenerationRequest): Observable<any> {\n    if (!this.hasApiKey()) {\n      return throwError(() => new Error('Gemini API 키가 설정되지 않았습니다. 설정에서 API 키를 입력해주세요.'));\n    }\n\n    const prompt = this.buildScenarioPrompt(request);\n    \n    return from(\n      this.ai.models.generateContent({\n        model: 'gemini-2.5-flash',\n        contents: prompt,\n      })\n    ).pipe(\n      map(response => {\n        if (response && response.text) {\n          const generatedText = response.text;\n          return this.parseScenarioResponse(generatedText);\n        }\n        throw new Error('응답 형식이 올바르지 않습니다.');\n      }),\n      catchError(error => {\n        console.warn('Gemini API 시나리오 생성 오류 상세:', error);\n        \n        let errorMessage = 'AI 시나리오 생성에 실패했습니다.';\n        \n        if (error.message) {\n          errorMessage = error.message;\n        }\n        \n        return throwError(() => new Error(errorMessage));\n      })\n    );\n  }\n\n  // 무협 캐릭터 생성\n  generateCharacter(characterType?: string): Observable<any> {\n    if (!this.hasApiKey()) {\n      return throwError(() => new Error('Gemini API 키가 설정되지 않았습니다.'));\n    }\n\n    const prompt = this.buildCharacterPrompt(characterType);\n    \n    return from(\n      this.ai.models.generateContent({\n        model: 'gemini-2.5-flash',\n        contents: prompt,\n      })\n    ).pipe(\n      map(response => {\n        if (response && response.text) {\n          const generatedText = response.text;\n          return this.parseCharacterResponse(generatedText);\n        }\n        throw new Error('응답 형식이 올바르지 않습니다.');\n      }),\n      catchError(error => {\n        console.warn('Gemini API 캐릭터 생성 오류 상세:', error);\n        \n        let errorMessage = 'AI 캐릭터 생성에 실패했습니다.';\n        if (error.message) {\n          errorMessage += ' - ' + error.message;\n        }\n        \n        return throwError(() => new Error(errorMessage));\n      })\n    );\n  }\n\n  // 시나리오 프롬프트 생성\n  private buildScenarioPrompt(request: ScenarioGenerationRequest): string {\n    const genre = request.genre || '무협';\n    const style = request.style || '전통적인';\n    const mood = request.mood || '긴장감 넘치는';\n    const context = request.additionalContext || '';\n    const isAdult = request.isAdult || false;\n\n    const adultGuidance = isAdult ? `\n- 🔞 성인 콘텐츠: 예 (19+) - 폭력적이고 선정적인 요소 포함 가능` : `\n- 성인 콘텐츠: 아니오 (전연령)`;\n\n    return `당신은 전문 무협 소설 작가입니다. 다음 조건에 맞는 무협 소설 시나리오를 생성해주세요.\n\n**조건:**\n- 장르: ${genre}\n- 스타일: ${style}\n- 분위기: ${mood}\n${context ? `- 추가 요구사항: ${context}` : ''}${adultGuidance}\n\n**생성 형식 (정확히 이 형식으로만 응답):**\n\n제목: [흥미진진한 시나리오 제목]\n\n설명: [시나리오에 대한 2-3문장의 간략한 설명]\n\n등장인물:\n- [인물1 이름/역할]\n- [인물2 이름/역할]\n- [인물3 이름/역할]\n- [인물4 이름/역할]\n\n배경: [시간과 장소를 포함한 상세한 배경 설명]\n\n갈등: [이야기의 핵심 갈등이나 문제 상황]\n\n목표: [주인공이 달성하고자 하는 목표]\n\n분위기: [이야기의 전반적인 분위기나 톤]\n\n태그: [태그1, 태그2, 태그3, 태그4, 태그5]\n\n**중요: 위 형식을 정확히 지켜서 응답해주세요. 각 섹션은 정확한 레이블로 시작해야 합니다.**`;\n  }\n\n  // 캐릭터 프롬프트 생성\n  private buildCharacterPrompt(characterType?: string): string {\n    const type = characterType || '주인공';\n\n    return `당신은 전문 무협 소설 작가입니다. ${type} 캐릭터를 생성해주세요.\n\n**생성 형식:**\n\n이름: [무협풍의 이름]\n나이: [숫자만]\n성별: [남성/여성]\n역할: [주인공/적대자/조연/단역]\n외모: [상세한 외모 묘사]\n성격: [성격 특징]\n배경: [캐릭터의 배경 스토리]\n능력: [무공/능력1, 무공/능력2, 무공/능력3]\n목표: [캐릭터의 목표나 동기]\n특성: [특성1, 특성2, 특성3]\n\n**중요: 위 형식을 정확히 지켜서 응답해주세요.**`;\n  }\n\n  // 시나리오 응답 파싱\n  private parseScenarioResponse(text: string): any {\n    try {\n      const result: any = {};\n\n      // 제목 추출\n      const titleMatch = text.match(/제목:\\s*(.+)/);\n      if (titleMatch) {\n        result.title = titleMatch[1].trim();\n      }\n\n      // 설명 추출\n      const descMatch = text.match(/설명:\\s*(.+?)(?=\\n\\n|등장인물:|$)/s);\n      if (descMatch) {\n        result.description = descMatch[1].trim();\n      }\n\n      // 등장인물 추출\n      const charactersMatch = text.match(/등장인물:\\s*([\\s\\S]+?)(?=\\n\\n|배경:|$)/);\n      if (charactersMatch) {\n        result.characters = charactersMatch[1]\n          .split('\\n')\n          .filter(line => line.trim().startsWith('-'))\n          .map(line => line.replace(/^-\\s*/, '').trim());\n      }\n\n      // 배경 추출\n      const settingMatch = text.match(/배경:\\s*(.+?)(?=\\n\\n|갈등:|$)/s);\n      if (settingMatch) {\n        result.setting = settingMatch[1].trim();\n      }\n\n      // 갈등 추출\n      const conflictMatch = text.match(/갈등:\\s*(.+?)(?=\\n\\n|목표:|$)/s);\n      if (conflictMatch) {\n        result.conflict = conflictMatch[1].trim();\n      }\n\n      // 목표 추출\n      const goalMatch = text.match(/목표:\\s*(.+?)(?=\\n\\n|분위기:|$)/s);\n      if (goalMatch) {\n        result.goal = goalMatch[1].trim();\n      }\n\n      // 분위기 추출\n      const moodMatch = text.match(/분위기:\\s*(.+?)(?=\\n\\n|태그:|$)/s);\n      if (moodMatch) {\n        result.mood = moodMatch[1].trim();\n      }\n\n      // 태그 추출\n      const tagsMatch = text.match(/태그:\\s*(.+?)$/s);\n      if (tagsMatch) {\n        result.tags = tagsMatch[1]\n          .split(',')\n          .map(tag => tag.trim())\n          .filter(tag => tag.length > 0);\n      }\n\n      return result;\n    } catch (error) {\n      throw new Error('AI 응답을 파싱하는데 실패했습니다.');\n    }\n  }\n\n  // 캐릭터 응답 파싱\n  private parseCharacterResponse(text: string): any {\n    try {\n      const result: any = {};\n\n      // 이름 추출\n      const nameMatch = text.match(/이름:\\s*(.+)/);\n      if (nameMatch) {\n        result.name = nameMatch[1].trim();\n      }\n\n      // 나이 추출\n      const ageMatch = text.match(/나이:\\s*(\\d+)/);\n      if (ageMatch) {\n        result.age = parseInt(ageMatch[1]);\n      }\n\n      // 성별 추출\n      const genderMatch = text.match(/성별:\\s*(.+?)(?=\\n|$)/);\n      if (genderMatch) {\n        const gender = genderMatch[1].trim();\n        if (gender.includes('남')) {\n          result.gender = 'male';\n        } else if (gender.includes('여')) {\n          result.gender = 'female';\n        } else {\n          result.gender = 'other';\n        }\n      }\n\n      // 역할 추출\n      const roleMatch = text.match(/역할:\\s*(.+?)(?=\\n|$)/);\n      if (roleMatch) {\n        const role = roleMatch[1].trim();\n        if (role.includes('주인공')) {\n          result.role = 'protagonist';\n        } else if (role.includes('적대') || role.includes('악역')) {\n          result.role = 'antagonist';\n        } else if (role.includes('조연')) {\n          result.role = 'supporting';\n        } else {\n          result.role = 'minor';\n        }\n      }\n\n      // 외모 추출\n      const appearanceMatch = text.match(/외모:\\s*(.+?)(?=\\n\\n|성격:|$)/s);\n      if (appearanceMatch) {\n        result.appearance = appearanceMatch[1].trim();\n      }\n\n      // 성격 추출\n      const personalityMatch = text.match(/성격:\\s*(.+?)(?=\\n\\n|배경:|$)/s);\n      if (personalityMatch) {\n        result.personality = personalityMatch[1].trim();\n      }\n\n      // 배경 추출\n      const backgroundMatch = text.match(/배경:\\s*(.+?)(?=\\n\\n|능력:|$)/s);\n      if (backgroundMatch) {\n        result.background = backgroundMatch[1].trim();\n      }\n\n      // 능력 추출\n      const abilitiesMatch = text.match(/능력:\\s*(.+?)(?=\\n\\n|목표:|$)/s);\n      if (abilitiesMatch) {\n        result.abilities = abilitiesMatch[1]\n          .split(',')\n          .map(a => a.trim())\n          .filter(a => a.length > 0);\n      }\n\n      // 목표 추출\n      const goalsMatch = text.match(/목표:\\s*(.+?)(?=\\n\\n|특성:|$)/s);\n      if (goalsMatch) {\n        result.goals = goalsMatch[1].trim();\n      }\n\n      // 특성 추출\n      const traitsMatch = text.match(/특성:\\s*(.+?)$/s);\n      if (traitsMatch) {\n        result.traits = traitsMatch[1]\n          .split(',')\n          .map(t => t.trim())\n          .filter(t => t.length > 0);\n      }\n\n      return result;\n    } catch (error) {\n      throw new Error('AI 응답을 파싱하는데 실패했습니다.');\n    }\n  }\n\n  // 무협 아이템 생성\n  generateItem(itemType: string = '무기', grade: string = '고급'): Observable<any> {\n    if (!this.hasApiKey()) {\n      return throwError(() => new Error('API 키가 설정되지 않았습니다.'));\n    }\n\n    const prompt = this.buildItemPrompt(itemType, grade);\n    \n    return from(\n      this.ai.models.generateContent({\n        model: 'gemini-2.5-flash',\n        contents: prompt,\n      })\n    ).pipe(\n      map(response => {\n        if (response && response.text) {\n          return this.parseItemResponse(response.text);\n        }\n        throw new Error('AI 응답이 비어있습니다.');\n      }),\n      catchError(error => {\n        console.warn('Gemini API 아이템 생성 오류 상세:', error);\n        \n        let errorMessage = 'AI 아이템 생성에 실패했습니다.';\n        if (error.message) {\n          errorMessage = error.message;\n        }\n        \n        return throwError(() => new Error(errorMessage));\n      })\n    );\n  }\n\n  // 무협 아이템 생성 프롬프트\n  private buildItemPrompt(itemType: string, grade: string): string {\n    return `당신은 무협 소설의 아이템 디자이너입니다. 다음 조건에 맞는 ${itemType}을 생성해주세요.\n\n등급: ${grade}\n타입: ${itemType}\n\n다음 JSON 형식으로 응답해주세요:\n{\n  \"name\": \"아이템 이름 (한자 포함 가능, 예: 천마검(天魔劍))\",\n  \"description\": \"아이템에 대한 상세한 설명 (2-3문장)\",\n  \"type\": \"${itemType}\",\n  \"grade\": \"${grade}\",\n  \"effects\": [\"효과1\", \"효과2\", \"효과3\"],\n  \"stats\": {\n    \"attack\": 공격력 수치 (무기의 경우),\n    \"defense\": 방어력 수치 (방어구의 경우),\n    \"hp\": HP 보너스,\n    \"mp\": MP 보너스\n  },\n  \"requirements\": \"사용 조건 (예: 내공 500 이상, 검법 숙련도 상급)\",\n  \"lore\": \"아이템의 전설이나 유래 (1-2문장)\",\n  \"tags\": [\"태그1\", \"태그2\", \"태그3\"]\n}\n\n규칙:\n1. 아이템명은 무협 세계관에 어울리게 멋지고 웅장하게\n2. 등급에 맞는 능력치 설정 (일반: 10-30, 고급: 40-70, 희귀: 80-120, 전설: 130-200, 신화: 250+)\n3. 효과는 구체적이고 게임에서 사용 가능하도록\n4. 전설이나 유래는 신비롭고 흥미롭게\n5. 반드시 유효한 JSON 형식으로만 응답\n6. JSON 외의 다른 텍스트는 포함하지 말 것`;\n  }\n\n  // 무협 아이템 응답 파싱\n  private parseItemResponse(text: string): any {\n    try {\n      // JSON 블록 추출\n      const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\n      if (!jsonMatch) {\n        throw new Error('JSON 형식을 찾을 수 없습니다.');\n      }\n      \n      const parsedItem = JSON.parse(jsonMatch[0]);\n      \n      // 필수 필드 검증\n      if (!parsedItem.name || !parsedItem.description || !parsedItem.type) {\n        throw new Error('필수 필드가 누락되었습니다.');\n      }\n      \n      // effects가 배열이 아니면 배열로 변환\n      if (parsedItem.effects && !Array.isArray(parsedItem.effects)) {\n        parsedItem.effects = [parsedItem.effects];\n      }\n      \n      // tags가 배열이 아니면 배열로 변환\n      if (parsedItem.tags && !Array.isArray(parsedItem.tags)) {\n        parsedItem.tags = [parsedItem.tags];\n      }\n      \n      return parsedItem;\n    } catch (error) {\n      throw new Error('아이템 정보를 파싱하는데 실패했습니다.');\n    }\n  }\n\n  // 무협지 소설 생성 (3페이지 분량)\n  generateNovel(options: {\n    characters: any[];\n    scenarios: any[];\n    items: any[];\n    settings: any;\n  }): Observable<any> {\n    if (!this.hasApiKey()) {\n      return throwError(() => new Error('Gemini API 키가 설정되지 않았습니다.'));\n    }\n\n    const prompt = this.buildNovelPrompt(options);\n    \n    return from(\n      this.ai.models.generateContent({\n        model: 'gemini-2.5-flash',\n        contents: prompt,\n      })\n    ).pipe(\n      map(response => {\n        if (response && response.text) {\n          return { content: response.text };\n        }\n        throw new Error('응답 형식이 올바르지 않습니다.');\n      }),\n      catchError(error => {\n        console.warn('Gemini API 소설 생성 오류 상세:', error);\n        \n        let errorMessage = 'AI 소설 생성에 실패했습니다.';\n        if (error.message) {\n          errorMessage += ' - ' + error.message;\n        }\n        \n        return throwError(() => new Error(errorMessage));\n      })\n    );\n  }\n\n  // 소설 생성 프롬프트 생성\n  private buildNovelPrompt(options: {\n    characters: any[];\n    scenarios: any[];\n    items: any[];\n    settings: any;\n  }): string {\n    const { characters, scenarios, items, settings } = options;\n\n    // 캐릭터 정보 추출\n    let charactersInfo = '';\n    if (characters && characters.length > 0) {\n      charactersInfo = '\\n\\n**등장인물:**\\n';\n      characters.slice(0, 5).forEach(char => {\n        charactersInfo += `- ${char.name}`;\n        if (char.age) charactersInfo += ` (${char.age}세)`;\n        if (char.role) charactersInfo += ` - ${char.role === 'protagonist' ? '주인공' : char.role === 'antagonist' ? '적대자' : '조연'}`;\n        if (char.personality) charactersInfo += `\\n  성격: ${char.personality}`;\n        if (char.abilities && char.abilities.length > 0) {\n          charactersInfo += `\\n  무공/능력: ${char.abilities.join(', ')}`;\n        }\n        charactersInfo += '\\n';\n      });\n    }\n\n    // 시나리오/상황 정보 추출\n    let scenarioInfo = '';\n    if (scenarios && scenarios.length > 0) {\n      const scenario = scenarios[0]; // 첫 번째 시나리오 사용\n      scenarioInfo = '\\n\\n**상황 설정:**\\n';\n      if (scenario.title) scenarioInfo += `제목: ${scenario.title}\\n`;\n      if (scenario.description) scenarioInfo += `설명: ${scenario.description}\\n`;\n      if (scenario.setting) scenarioInfo += `배경: ${scenario.setting}\\n`;\n      if (scenario.conflict) scenarioInfo += `갈등: ${scenario.conflict}\\n`;\n      if (scenario.goal) scenarioInfo += `목표: ${scenario.goal}\\n`;\n      if (scenario.mood) scenarioInfo += `분위기: ${scenario.mood}\\n`;\n    }\n\n    // 아이템 정보 추출\n    let itemsInfo = '';\n    if (items && items.length > 0) {\n      itemsInfo = '\\n\\n**중요 아이템:**\\n';\n      items.slice(0, 3).forEach(item => {\n        itemsInfo += `- ${item.name}`;\n        if (item.type) itemsInfo += ` (${item.type})`;\n        if (item.description) itemsInfo += `: ${item.description}`;\n        itemsInfo += '\\n';\n      });\n    }\n\n    // 기본 설정 정보\n    const genre = settings.genre || 'traditional';\n    const protagonistName = settings.protagonist || '검성';\n    const theme = settings.theme || 'revenge';\n    const violence = settings.violence || 'moderate';\n    const romance = settings.romance || 'none';\n    const isAdult = settings.adult || false;\n\n    // 성인 콘텐츠 설정에 따른 추가 지침\n    const adultContentGuidance = isAdult ? `\n\n**🔞 성인 콘텐츠 반영 (19+):**\n- 성인 독자를 대상으로 한 수위 높은 표현 사용 가능\n- 폭력: 더 직접적이고 사실적인 전투 및 폭력 묘사\n- 로맨스/관능: 은유적이지 않은 직접적이고 노골적인 표현 허용\n- 언어: 거친 언어, 욕설, 성인용 표현 사용 가능\n- 주제: 복수, 배신, 욕망 등 어두운 주제를 더욱 깊이 있게 다룸\n- 심리: 인간의 어두운 면과 욕망을 솔직하게 표현` : `\n\n**일반 독자용 콘텐츠:**\n- 전연령 또는 청소년 이상 독자 대상\n- 폭력과 로맨스 표현을 적절히 절제\n- 건전한 언어 사용`;\n\n    const prompt = `당신은 전문 무협 소설 작가입니다. 다음 정보를 바탕으로 흥미진진한 무협지 3페이지 분량(약 3000-4000자)을 작성해주세요.\n\n**소설 설정:**\n- 장르: ${genre}\n- 주인공: ${protagonistName}\n- 주제: ${theme}\n- 폭력 수위: ${violence}\n- 로맨스 수위: ${romance}\n- 성인 콘텐츠: ${isAdult ? '🔞 예 (19+)' : '아니오 (전연령)'}\n${adultContentGuidance}\n${charactersInfo}\n${scenarioInfo}\n${itemsInfo}\n\n**작성 요구사항:**\n1. 전통 무협지 스타일로 작성\n2. 3페이지 분량 (약 3000-4000자)\n3. 저장된 캐릭터, 상황, 아이템을 자연스럽게 활용\n4. 시작-전개-절정의 구조를 갖춘 완결된 이야기\n5. 생동감 넘치는 전투 장면과 캐릭터의 감정 묘사\n6. 적절한 단락 구분과 장면 전환\n${isAdult ? '7. 🔞 성인 콘텐츠 설정이 활성화되어 있으므로, 수위 높은 표현과 노골적인 묘사를 적극 활용하여 성인 독자의 기대에 부응' : '7. 전연령 또는 청소년 이상 독자를 위한 적절한 표현 수위 유지'}\n\n**형식:**\n- 제목을 포함하여 작성\n- 장(章)으로 구분 (제1장, 제2장, 제3장)\n- 각 장은 약 1000자 내외\n- 무협 소설 특유의 문체와 용어 사용\n\n지금 바로 소설을 작성해주세요:`;\n\n    return prompt;\n  }\n\n  // API 테스트\n  testConnection(): Observable<boolean> {\n    if (!this.hasApiKey()) {\n      return throwError(() => new Error('API 키가 설정되지 않았습니다.'));\n    }\n\n    return from(\n      this.ai.models.generateContent({\n        model: 'gemini-2.5-flash',\n        contents: '안녕하세요',\n      })\n    ).pipe(\n      map(() => true),\n      catchError(() => throwError(() => new Error('API 연결 테스트 실패')))\n    );\n  }\n\n  // 범용 컨텐츠 생성 메서드\n  generateContent(prompt: string): Observable<string> {\n    if (!this.hasApiKey()) {\n      return throwError(() => new Error('API 키가 설정되지 않았습니다.'));\n    }\n\n    return from(\n      this.ai.models.generateContent({\n        model: 'gemini-2.5-flash',\n        contents: prompt,\n      })\n    ).pipe(\n      map(response => {\n        if (response && response.text) {\n          return response.text;\n        }\n        throw new Error('응답 형식이 올바르지 않습니다.');\n      }),\n      catchError(error => {\n        return throwError(() => new Error('컨텐츠 생성에 실패했습니다.'));\n      })\n    );\n  }\n\n  // 🆕 상품 정보 AI 자동 생성\n  // 🆕 상품 정보 AI 자동 생성\n  generateProductInfo(productType: string, keywords?: string): Observable<any> {\n    if (!this.hasApiKey()) {\n      return throwError(() => new Error('Gemini API 키가 설정되지 않았습니다.'));\n    }\n\n    const prompt = this.buildProductPrompt(productType, keywords);\n    \n    return from(\n      this.ai.models.generateContent({\n        model: 'gemini-2.5-flash',\n        contents: prompt,\n      })\n    ).pipe(\n      map(response => {\n        if (response && response.text) {\n          return this.parseProductResponse(response.text);\n        }\n        throw new Error('응답 형식이 올바르지 않습니다.');\n      }),\n      catchError(error => {\n        let errorMessage = 'AI 상품 생성에 실패했습니다.';\n        if (error.message) {\n          errorMessage = error.message;\n        }\n        return throwError(() => new Error(errorMessage));\n      })\n    );\n  }\n\n  // 상품 생성 프롬프트\n  private buildProductPrompt(productType: string, keywords?: string): string {\n    const keywordText = keywords ? `키워드: ${keywords}` : '';\n    \n    return `당신은 전문 상품 기획자입니다. 다음 조건에 맞는 상품 정보를 생성해주세요.\n\n**조건:**\n- 상품 유형: ${productType}\n${keywordText}\n\n**생성 형식 (정확히 이 JSON 형식으로만 응답):**\n\n\\`\\`\\`json\n{\n  \"name\": \"매력적인 상품명 (20자 이내)\",\n  \"category\": \"적절한 카테고리\",\n  \"price\": 적정가격숫자,\n  \"discount\": 할인액숫자,\n  \"discountType\": \"won\",\n  \"shippingFee\": 배송비숫자,\n  \"detail\": \"상품 상세 설명 (200-500자, HTML 태그 없이 일반 텍스트만)\",\n  \"features\": [\n    \"특징1\",\n    \"특징2\",\n    \"특징3\"\n  ],\n  \"tags\": [\"태그1\", \"태그2\", \"태그3\"]\n}\n\\`\\`\\`\n\n**주의사항:**\n- 상품명은 간결하고 매력적으로\n- 가격은 시장 조사를 바탕으로 현실적으로\n- 상세 설명은 구매 욕구를 자극하되 과장하지 말 것\n- 특징은 3-5개 정도로\n- JSON 형식을 정확히 지킬 것`;\n  }\n\n  // 상품 응답 파싱\n  private parseProductResponse(text: string): any {\n    try {\n      // JSON 블록 추출\n      const jsonMatch = text.match(/```json\\s*([\\s\\S]*?)\\s*```/);\n      if (jsonMatch && jsonMatch[1]) {\n        const jsonStr = jsonMatch[1].trim();\n        return JSON.parse(jsonStr);\n      }\n\n      // 직접 JSON 파싱 시도\n      const cleanedText = text.trim();\n      if (cleanedText.startsWith('{')) {\n        return JSON.parse(cleanedText);\n      }\n\n      throw new Error('JSON 형식을 찾을 수 없습니다.');\n    } catch (error) {\n      throw new Error('AI 응답을 파싱하는데 실패했습니다.');\n    }\n  }\n}\n\n"],
  "mappings": "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",
  "names": []
}

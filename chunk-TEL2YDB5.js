import{e as B}from"./chunk-KRR2UDNI.js";import{d as T}from"./chunk-LZ4XSYEC.js";import{I as r,Ta as R,ab as u,ba as f,cb as m,f as c,ga as d,gb as b,z as k,za as A}from"./chunk-5TLQJ6AI.js";var j=class o{contexts={};currentContext=null;contextStack=[];constructor(){console.log("ChatflowLogicContextManager initialized")}registerContext(t,e){this.contexts[t]=e,console.log(`\uCEE8\uD14D\uC2A4\uD2B8 \uB4F1\uB85D\uB428: ${t}`)}changeContext(t,e=!1){e&&this.currentContext&&(this.contextStack.push(this.currentContext),console.log("\uC774\uC804 \uCEE8\uD14D\uC2A4\uD2B8\uB97C \uC2A4\uD0DD\uC5D0 \uC800\uC7A5:",this.currentContext.contextName)),this.currentContext=t,console.log(`\uCEE8\uD14D\uC2A4\uD2B8 \uBCC0\uACBD\uB428: ${t.contextName}`)}returnToPreviousContext(){let t=this.contextStack.pop();return t?(this.currentContext=t,console.log(`\uC774\uC804 \uCEE8\uD14D\uC2A4\uD2B8\uB85C \uBCF5\uADC0: ${t.contextName}`),t):(console.warn("\uB3CC\uC544\uAC08 \uC774\uC804 \uCEE8\uD14D\uC2A4\uD2B8\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4."),null)}getContext(t){return this.contexts[t]}clearAllContexts(){this.contexts={},this.currentContext=null,this.contextStack=[],console.log("\uBAA8\uB4E0 \uCEE8\uD14D\uC2A4\uD2B8\uAC00 \uCD08\uAE30\uD654\uB418\uC5C8\uC2B5\uB2C8\uB2E4.")}removeContext(t){this.contexts[t]&&(delete this.contexts[t],console.log(`\uCEE8\uD14D\uC2A4\uD2B8 \uC81C\uAC70\uB428: ${t}`))}static \u0275fac=function(e){return new(e||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};var s=class{data};var x=class o extends s{loadingFinished$=new b;ngOnInit(){if(this.data.isLoading===!1){this.loadingFinished$.emit(!0);return}k(this.data.loadingSec*1e3).pipe(r(1)).subscribe(e=>{this.data.isLoading=!1,this.loadingFinished$.emit(!0)})}static \u0275fac=(()=>{let t;return function(i){return(t||(t=A(o)))(i||o)}})();static \u0275dir=u({type:o,features:[m]})};var v=class extends s{clicked$=new b;onClick(t){this.clicked$.emit(t)}};var C=class o extends s{constructor(e){super();this.chatbotActionService=e}ngOnInit(){this.chatbotActionService.questionCreated$&&this.chatbotActionService.questionCreated$.next(this.data.text)}static \u0275fac=function(i){return new(i||o)(R(l))};static \u0275dir=u({type:o,features:[m]})};var l=class o{question="";chatbotScrollBody;chatbotContent;chatStyleSetting={answer:x,question:C,button:v};router=d(T);questionCreated$=null;messageCreated$=new c;createChatComponent(t,e){let i=this.chatbotContent.createComponent(t),n=i.instance;return e&&(n.data=e),this.messageCreated$.next(),i}static \u0275fac=function(e){return new(e||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};var a=class{constructor(t){this.logicReader=t}readData={};chatbotActionService=d(l);end(t){let e=window.debugLogger;if(e&&(e.info("\uCC57\uD50C\uB85C\uC6B0-\uB85C\uC9C1",`\u{1F3C1} NodeLogic.end() \uD638\uCD9C\uB428 (${this.readData.type})`),e.info("\uCC57\uD50C\uB85C\uC6B0-\uB85C\uC9C1",`   rightNodeIds: [${this.readData.rightNodeIds?.join(", ")||"\uC5C6\uC74C"}]`),e.info("\uCC57\uD50C\uB85C\uC6B0-\uB85C\uC9C1",`   rightNodeIds.length: ${this.readData.rightNodeIds?.length||0}`),e.info("\uCC57\uD50C\uB85C\uC6B0-\uB85C\uC9C1",`   \uC9C0\uC815\uB41C rightNodeId: ${t||"\uC5C6\uC74C"}`)),this.readData.rightNodeIds.length===0){console.log("\uC5F0\uACB0\uB41C \uB178\uB4DC\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4."),e&&e.warn("\uCC57\uD50C\uB85C\uC6B0-\uB85C\uC9C1","\u26A0\uFE0F \uC5F0\uACB0\uB41C \uB178\uB4DC\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4. \uC2DC\uBBAC\uB808\uC774\uC158 \uC911\uB2E8.");return}if(t){e&&e.info("\uCC57\uD50C\uB85C\uC6B0-\uB85C\uC9C1",`\u27A1\uFE0F \uB2E4\uC74C \uB178\uB4DC \uC2E4\uD589: ${t}`),this.logicReader.execute(t);return}e&&e.info("\uCC57\uD50C\uB85C\uC6B0-\uB85C\uC9C1",`\u27A1\uFE0F \uB2E4\uC74C \uB178\uB4DC \uC2E4\uD589: ${this.readData.rightNodeIds[0]}`),this.logicReader.execute(this.readData.rightNodeIds[0])}};var N=class extends a{start(){console.log("button node started",this.readData.data),this.chatbotActionService.createChatComponent(this.chatbotActionService.chatStyleSetting.button,this.readData.data).instance.clicked$.pipe(r(1)).subscribe(e=>{if(this.readData.data.conditions.indexOf(e)<0){console.log("\uC77C\uCE58\uD558\uB294 \uAC12\uC744 \uCC3E\uC9C0 \uBABB\uD588\uC2B5\uB2C8\uB2E4."),this.end();return}this.logicReader.variables[this.readData.data.variableName]=e.routingKey,this.end(e.targetNodeId)})}};var S=class extends a{start(){let t=window.debugLogger;t&&(t.info("\uCC57\uD50C\uB85C\uC6B0-\uB85C\uC9C1","\u{1F3C1} EndLogic.start() \uD638\uCD9C\uB428"),t.success("\uCC57\uD50C\uB85C\uC6B0-\uB85C\uC9C1","\u2705 \uCC57\uD50C\uB85C\uC6B0 \uC885\uB8CC \uC774\uBCA4\uD2B8 \uBC1C\uC0DD")),this.logicReader.$chatflowEnded.next(!0)}};var y=class extends a{questionCreated$=new c;debugLogger=d(B);start(){this.debugLogger.info("\uCC57\uD50C\uB85C\uC6B0-Listen",`Listen \uB85C\uC9C1 \uC2DC\uC791 (\uBCC0\uC218: ${this.readData.data.variableName})`),this.chatbotActionService.questionCreated$=this.questionCreated$,this.debugLogger.info("\uCC57\uD50C\uB85C\uC6B0-Listen",`\uC0AC\uC6A9\uC790 \uC785\uB825 \uB300\uAE30 \uC911... (\uBCC0\uC218: ${this.readData.data.variableName})`),this.chatbotActionService.questionCreated$.pipe(r(1)).subscribe(t=>{this.debugLogger.info("\uCC57\uD50C\uB85C\uC6B0-Listen",`\uC0AC\uC6A9\uC790 \uC785\uB825 \uC218\uC2E0: "${t}"`),this.chatbotActionService.questionCreated$=null,this.logicReader.variables[this.readData.data.variableName]=t,this.debugLogger.success("\uCC57\uD50C\uB85C\uC6B0-Listen",`\uBCC0\uC218 \uC800\uC7A5 \uC644\uB8CC: ${this.readData.data.variableName} = "${this.logicReader.variables[this.readData.data.variableName]}"`),this.end()})}end(){this.debugLogger.info("\uCC57\uD50C\uB85C\uC6B0-Listen",`Listen \uB85C\uC9C1 \uC885\uB8CC (\uB2E4\uC74C \uB178\uB4DC \uC218: ${this.readData.rightNodeIds?.length||0})`),super.end()}};var L=class extends a{start(){let t=window.debugLogger;t&&(t.info("\uCC57\uD50C\uB85C\uC6B0-Speak","\u{1F5E3}\uFE0F Speak \uB178\uB4DC \uC2DC\uC791"),t.info("\uCC57\uD50C\uB85C\uC6B0-Speak",`   \uD14D\uC2A4\uD2B8: "${this.readData.data.text}"`),t.info("\uCC57\uD50C\uB85C\uC6B0-Speak",`   \uB85C\uB529: ${this.readData.data.isLoading}, ${this.readData.data.loadingSec}\uCD08`));let e=this.readData.data.text,i=/\{\{\{(.+?)\}\}\}/g,n=e.matchAll(i);for(let h of n){let E=h[0],p=h[1];this.logicReader.variables[p]&&(e=e.replace(E,this.logicReader.variables[p]),t&&t.info("\uCC57\uD50C\uB85C\uC6B0-Speak",`   \uBCC0\uC218 \uCE58\uD658: {{{${p}}}} \u2192 ${this.logicReader.variables[p]}`))}t&&(t.info("\uCC57\uD50C\uB85C\uC6B0-Speak",`   \uCD5C\uC885 \uD14D\uC2A4\uD2B8: "${e}"`),t.info("\uCC57\uD50C\uB85C\uC6B0-Speak","   \uCC57\uBD07 \uBA54\uC2DC\uC9C0 \uC0DD\uC131 \uC911...")),this.chatbotActionService.createChatComponent(this.chatbotActionService.chatStyleSetting.answer,{text:e,isLoading:this.readData.data.isLoading,loadingSec:this.readData.data.loadingSec}).instance.loadingFinished$.pipe(r(1)).subscribe(h=>{t&&t.success("\uCC57\uD50C\uB85C\uC6B0-Speak","\u2705 Speak \uB178\uB4DC \uC644\uB8CC \u2192 \uB2E4\uC74C \uB178\uB4DC\uB85C \uC774\uB3D9"),this.end()})}};var $=class extends a{start(){if(console.log("Split node started",this.readData.data),this.readData.data.conditions.length===0){console.log("\uC870\uAC74\uBB38\uC774 \uC5C6\uC2B5\uB2C8\uB2E4."),this.end();return}if(!this.logicReader.variables[this.readData.data.variableName]){console.log("\uBCC0\uC218\uC5D0 \uAC12\uC774 \uC5C6\uC2B5\uB2C8\uB2E4."),this.end();return}let t="";this.readData.data.conditions.some((e,i)=>this.logicReader.variables[this.readData.data.variableName]===this.readData.data.conditions[i].routingKey?(t=this.readData.data.conditions[i].targetNodeId,!0):!1),t||(console.log("\uC77C\uCE58\uD558\uB294 \uAC12\uC744 \uCC3E\uC9C0 \uBABB\uD588\uC2B5\uB2C8\uB2E4."),this.end()),this.end(t)}};var D=class extends a{start(){let t=window.debugLogger;t&&(t.info("\uCC57\uD50C\uB85C\uC6B0-\uB85C\uC9C1","\u{1F3AC} StartLogic.start() \uD638\uCD9C\uB428"),t.info("\uCC57\uD50C\uB85C\uC6B0-\uB85C\uC9C1",`   readData.id: ${this.readData.id}`),t.info("\uCC57\uD50C\uB85C\uC6B0-\uB85C\uC9C1",`   readData.type: ${this.readData.type}`),t.info("\uCC57\uD50C\uB85C\uC6B0-\uB85C\uC9C1",`   rightNodeIds: [${this.readData.rightNodeIds?.join(", ")||"\uC5C6\uC74C"}]`)),this.end()}};var I=class extends a{start(){let t=this.readData.data.text,e=/\{\{\{(.+?)\}\}\}/g,i=t.matchAll(e);console.log(i);for(let g of i){let h=g[0];this.logicReader.variables[g[1]]&&(t=t.replace(h,this.logicReader.variables[g[1]]))}let n=this.chatbotActionService.createChatComponent(this.chatbotActionService.chatStyleSetting.question,{text:t});this.end()}};var q=class{constructor(t,e,i){this.contextName=t;this.contextManager=e;this.chatbotActionService=i;this.initializeNodeLogics(),console.log(`ChatflowLogicContext \uC0DD\uC131\uB428: ${t}`)}nodeLogics={};chatflowData={};variables={};$chatflowEnded=new c;currentNode$=new c;initializeNodeLogics(){this.nodeLogics.speak=new L(this),this.nodeLogics.start=new D(this),this.nodeLogics.listen=new y(this),this.nodeLogics.split=new $(this),this.nodeLogics.end=new S(this),this.nodeLogics.button=new N(this),this.nodeLogics.question=new I(this),import("./chunk-SE2WRO4X.js").then(t=>{this.nodeLogics.contextChanger=new t.ContextChangerLogic(this)})}start(){console.log(`\uCC57\uD50C\uB85C\uC6B0 \uC2DC\uC791: ${this.contextName}`),this.execute("start")}execute(t){let e=window.debugLogger;e&&e.info("\uCC57\uD50C\uB85C\uC6B0-\uCEE8\uD14D\uC2A4\uD2B8",`\u{1F504} execute() \uD638\uCD9C\uB428 - nodeId: ${t}, context: ${this.contextName}`);let i=this.chatflowData[t];if(!i){console.error(`\uB178\uB4DC\uB97C \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4: ${t}`);return}e&&e.info("\uCC57\uD50C\uB85C\uC6B0-\uCEE8\uD14D\uC2A4\uD2B8",`   \uB178\uB4DC \uD0C0\uC785: ${i.type}`),this.currentNode$.next(i);let n=this.nodeLogics[i.type];if(!n){console.error(`\uB178\uB4DC \uB85C\uC9C1\uC744 \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4: ${i.type}`);return}n.readData=i,n.start()}end(){console.log(`\uCC57\uD50C\uB85C\uC6B0 \uC885\uB8CC: ${this.contextName}`),this.$chatflowEnded.next()}reset(){this.variables={},this.chatflowData={},this.currentNode$.next(null),console.log(`\uCEE8\uD14D\uC2A4\uD2B8 \uCD08\uAE30\uD654\uB428: ${this.contextName}`)}switchToContext(t){let e=this.contextManager.getContext(t);e?(this.contextManager.changeContext(e,!0),e.start()):console.error(`\uCEE8\uD14D\uC2A4\uD2B8\uB97C \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4: ${t}`)}returnToPrevious(){let t=this.contextManager.returnToPreviousContext();t&&console.log(`\uC774\uC804 \uCEE8\uD14D\uC2A4\uD2B8\uB85C \uBCF5\uADC0: ${t.contextName}`)}};export{j as a,x as b,v as c,C as d,l as e,a as f,N as g,S as h,y as i,L as j,$ as k,D as l,I as m,q as n};

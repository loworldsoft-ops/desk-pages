{
  "version": 3,
  "sources": ["src/app/modules/chat-talk/shared/services/chatbot.service.ts"],
  "sourcesContent": ["import { Injectable } from '@angular/core';\nimport { HttpClient } from '@angular/common/http';\nimport { firstValueFrom, Observable } from 'rxjs';\n\n/**\n * 챗봇 응답 인터페이스\n */\nexport interface IBotResponse {\n  message: string;\n  action?: string | null;\n  quickReplies?: string[];\n}\n\n/**\n * 챗봇 설정 인터페이스\n */\ninterface ChatBotConfig {\n  chatbot: {\n    name: string;\n    description: string;\n    welcomeMessage: string;\n    defaultResponses: {\n      notFound: string;\n      error: string;\n      transferToAgent: string;\n    };\n  };\n  quickReplies: string[];\n  responses: {\n    [key: string]: {\n      keywords: string[];\n      message: string;\n      action?: string;\n    };\n  };\n  chatFlow: {\n    triggers: {\n      keywords: string[];\n      failureCount: number;\n      noMatchCount: number;\n    };\n    humanHandoff: {\n      message: string;\n      action: string;\n      endpoint: string;\n    };\n  };\n}\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class ChatBotService {\n  private chatbotConfig: ChatBotConfig | null = null;\n  private keywordResponseMap = new Map<string, IBotResponse>();\n  private noMatchCount = 0;\n  private failureCount = 0;\n\n  constructor(private http: HttpClient) {\n    this.loadChatbotConfig();\n  }\n\n  /**\n   * 챗봇 설정 파일 로드\n   */\n  private async loadChatbotConfig(): Promise<void> {\n    try {\n      this.chatbotConfig = await firstValueFrom(\n        this.http.get<ChatBotConfig>('/assets/json/chat-talk-config.json')\n      );\n      this.buildKeywordMap();\n    } catch (error) {\n      // 기본 설정 사용\n      this.setDefaultConfig();\n    }\n  }\n\n  /**\n   * 기본 설정 사용\n   */\n  private setDefaultConfig(): void {\n    this.chatbotConfig = {\n      chatbot: {\n        name: '스토어 챗봇',\n        description: 'Store 전용 고객 상담 챗봇',\n        welcomeMessage: '안녕하세요! 무엇을 도와드릴까요?',\n        defaultResponses: {\n          notFound: '죄송합니다. 정확한 답변을 찾기 어려워요. 상담원 연결을 원하시면 \"상담원\"이라고 말씀해 주세요.',\n          error: '일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요.',\n          transferToAgent: '상담원에게 연결해드리겠습니다. 잠시만 기다려주세요.'\n        }\n      },\n      quickReplies: ['상품 문의', '주문 조회', '배송 문의', '상담원 연결'],\n      responses: {\n        greeting: {\n          keywords: ['안녕', '안녕하세요', '처음'],\n          message: '안녕하세요! 무엇을 도와드릴까요?'\n        },\n        human_agent: {\n          keywords: ['상담원', '상담사', '사람', '직원', '연결'],\n          message: '상담원에게 연결해드리겠습니다.',\n          action: 'connectAgent'\n        }\n      },\n      chatFlow: {\n        triggers: {\n          keywords: ['상담원', '상담사', '사람'],\n          failureCount: 3,\n          noMatchCount: 2\n        },\n        humanHandoff: {\n          message: '상담원에게 연결해드리겠습니다.',\n          action: 'connectAgent',\n          endpoint: '/api/chat-talk/transfer-to-human'\n        }\n      }\n    };\n    this.buildKeywordMap();\n  }\n\n  /**\n   * 키워드 → 응답 맵 생성\n   */\n  private buildKeywordMap(): void {\n    if (!this.chatbotConfig?.responses) return;\n\n    Object.entries(this.chatbotConfig.responses).forEach(([intentName, responseConfig]) => {\n      const response: IBotResponse = {\n        message: responseConfig.message,\n        action: responseConfig.action || null,\n        quickReplies: this.chatbotConfig?.quickReplies || []\n      };\n\n      // 각 키워드를 맵에 등록\n      responseConfig.keywords?.forEach((keyword: string) => {\n        this.keywordResponseMap.set(keyword.toLowerCase(), response);\n      });\n    });\n\n  }\n\n  /**\n   * 사용자 메시지 처리 및 봇 응답 생성\n   */\n  async processMessage(userMessage: string): Promise<IBotResponse> {\n    // 설정이 아직 로드되지 않았다면 대기\n    if (!this.chatbotConfig) {\n      await this.loadChatbotConfig();\n    }\n\n    const normalizedMessage = this.normalizeMessage(userMessage);\n\n    // 1차: 키워드 정확 매칭\n    let response = this.findExactKeywordMatch(normalizedMessage);\n\n    if (!response) {\n      // 2차: 부분 매칭\n      response = this.findPartialMatch(normalizedMessage);\n    }\n\n    if (response) {\n      this.resetCounters();\n      return response;\n    }\n\n    // 매칭 실패 처리\n    return this.handleNoMatch();\n  }\n\n  /**\n   * 메시지 정규화\n   */\n  private normalizeMessage(message: string): string {\n    return message\n      .toLowerCase()\n      .trim()\n      .replace(/[^\\w\\sㄱ-ㅎㅏ-ㅣ가-힣]/g, '') // 특수문자 제거\n      .replace(/\\s+/g, ' '); // 공백 정리\n  }\n\n  /**\n   * 정확한 키워드 매칭\n   */\n  private findExactKeywordMatch(message: string): IBotResponse | null {\n    return this.keywordResponseMap.get(message) || null;\n  }\n\n  /**\n   * 부분 매칭\n   */\n  private findPartialMatch(message: string): IBotResponse | null {\n    for (const [keyword, response] of this.keywordResponseMap.entries()) {\n      if (message.includes(keyword) || keyword.includes(message)) {\n        return response;\n      }\n    }\n    return null;\n  }\n\n  /**\n   * 매칭 실패 처리\n   */\n  private handleNoMatch(): IBotResponse {\n    this.noMatchCount++;\n    this.failureCount++;\n\n    const config = this.chatbotConfig!;\n    const triggers = config.chatFlow.triggers;\n\n    // 실패 횟수가 임계값을 초과하면 상담원 연결\n    if (this.failureCount >= triggers.failureCount || \n        this.noMatchCount >= triggers.noMatchCount) {\n      this.resetCounters();\n      return {\n        message: config.chatFlow.humanHandoff.message,\n        action: config.chatFlow.humanHandoff.action,\n        quickReplies: []\n      };\n    }\n\n    return {\n      message: config.chatbot.defaultResponses.notFound,\n      quickReplies: config.quickReplies\n    };\n  }\n\n  /**\n   * 카운터 리셋\n   */\n  private resetCounters(): void {\n    this.noMatchCount = 0;\n    this.failureCount = 0;\n  }\n\n  /**\n   * 환영 메시지 가져오기\n   */\n  getWelcomeMessage(): string {\n    return this.chatbotConfig?.chatbot.welcomeMessage || '안녕하세요!';\n  }\n\n  /**\n   * 빠른 답장 가져오기\n   */\n  getQuickReplies(): string[] {\n    return this.chatbotConfig?.quickReplies || [];\n  }\n}\n"],
  "mappings": "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",
  "names": []
}

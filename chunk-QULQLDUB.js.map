{
  "version": 3,
  "sources": ["src/app/modules/membership/util/role-id.enum.ts", "src/app/modules/membership/membership.service.ts"],
  "sourcesContent": ["export enum RoleId {\n  User = 100,\n  Admin = 200,\n  SuperAdmin = 300,\n}\n", "import { Injectable } from '@angular/core';\nimport { HttpClient, HttpParams } from '@angular/common/http';\nimport { BehaviorSubject, Observable } from 'rxjs';\nimport { Router } from '@angular/router';\nimport { JwtHelperService } from '@auth0/angular-jwt';\nimport { User, UserPermission, Organization } from './interfaces/user.interface';\nimport { LoginDto } from './dto/login.dto';\nimport { CreateUserDto } from './dto/create-user.dto';\nimport { UpdateUserDto } from './dto/update-user.dto';\nimport { UpdateAdminDto } from './dto/update-admin.dto';\nimport { UpdatePasswordDto } from './dto/update-password.dto';\nimport { ResetPasswordDto } from './dto/reset-password.dto';\nimport { ValidatePasswordDto } from './dto/validate-password.dto';\nimport { RoleId } from './util/role-id.enum';\nimport { environment } from '../../../environments/environment';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class MembershipService {\n  private baseUrl = `${environment.apiUrl}/users`;\n  private user$ = new BehaviorSubject<User>({} as User);\n  private _isLoggedIn = false;\n\n  selectedOrganization: Organization = {} as Organization;\n  organizationPermission: UserPermission = {} as UserPermission;\n\n  constructor(\n    private http: HttpClient,\n    private jwtHelper: JwtHelperService,\n    private router: Router\n  ) {\n    this.initUser();\n    this.checkStatus();\n  }\n\n  get currentUser(): User {\n    return this.user$.value;\n  }\n\n  get user(): Observable<User> {\n    return this.user$.asObservable();\n  }\n\n  get isLoggedIn(): boolean {\n    return this._isLoggedIn;\n  }\n\n  // 인증 관련\n  login<T>(param: LoginDto): Observable<T> {\n    return this.http.post<T>(`${this.baseUrl}/login`, param);\n  }\n\n  logout(): void {\n    this.user$.next({} as User);\n    localStorage.removeItem('loworld_accessToken');\n    localStorage.removeItem('user');\n    this.router.navigate(['/membership/login']);\n  }\n\n  signup<T>(param: CreateUserDto): Observable<T> {\n    return this.http.post<T>(this.baseUrl, param);\n  }\n\n  // 사용자 조회\n  getAllUsers<T>(): Observable<T> {\n    return this.http.get<T>(this.baseUrl);\n  }\n\n  getUserList<T>(): Observable<T> {\n    const params = new HttpParams().set('role', RoleId.User);\n    return this.http.get<T>(`${this.baseUrl}/roles`, { params });\n  }\n\n  getAdminList<T>(): Observable<T> {\n    const params = new HttpParams().set('role', RoleId.SuperAdmin);\n    return this.http.get<T>(`${this.baseUrl}/roles`, { params });\n  }\n\n  getUsersByRole<T>(roleId: RoleId): Observable<T> {\n    const params = new HttpParams().set('role', roleId);\n    return this.http.get<T>(`${this.baseUrl}/roles`, { params });\n  }\n\n  getOrganizationMembers<T>(organizationId: string, role?: RoleId): Observable<T> {\n    const params = new HttpParams()\n      .set('organizationId', organizationId)\n      .set('role', role ?? 100);\n    return this.http.get<T>(`${this.baseUrl}/organizations`, { params });\n  }\n\n  // 사용자 수정\n  updateUser<T>(param: UpdateUserDto): Observable<T> {\n    return this.http.post<T>(`${this.baseUrl}/update`, param);\n  }\n\n  updateAdmin<T>(param: UpdateAdminDto): Observable<T> {\n    return this.http.post<T>(`${this.baseUrl}/admin`, param);\n  }\n\n  // 비밀번호 관리\n  updatePassword<T>(param: UpdatePasswordDto): Observable<T> {\n    return this.http.post<T>(`${this.baseUrl}/init`, param);\n  }\n\n  validatePassword<T>(param: ValidatePasswordDto): Observable<T> {\n    return this.http.post<T>(`${this.baseUrl}/valid`, param);\n  }\n\n  resetPassword<T>(param: ResetPasswordDto): Observable<T> {\n    return this.http.post<T>(`${this.baseUrl}/reset`, param);\n  }\n\n  // 사용자 삭제\n  deleteUser<T>(userIdx: number): Observable<T> {\n    return this.http.post<T>(`${this.baseUrl}/delete`, { userIdx });\n  }\n\n  deleteUserById<T>(userId: string): Observable<T> {\n    const params = new HttpParams().set('userId', userId);\n    return this.http.delete<T>(this.baseUrl, { params });\n  }\n\n  // 사용자 상태 관리\n  setUser(user: User): void {\n    this.user$.next(user);\n    localStorage.setItem('user', JSON.stringify(user));\n  }\n\n  getUser(): User | null {\n    const userStr = localStorage.getItem('user');\n    if (userStr) {\n      try {\n        return JSON.parse(userStr) as User;\n      } catch (e) {\n        console.warn('사용자 정보 파싱 실패:', e);\n        return null;\n      }\n    }\n    \n    // localStorage에 없으면 BehaviorSubject에서 가져오기\n    const currentUser = this.user$.value;\n    return currentUser && currentUser.id ? currentUser : null;\n  }\n\n  removeUser(): void {\n    this.user$.next({} as User);\n    localStorage.removeItem('user');\n  }\n\n  // JWT 토큰 관리\n  setToken(accessToken: string): void {\n    localStorage.setItem('loworld_accessToken', accessToken);\n  }\n\n  getToken(): string | null {\n    return localStorage.getItem('loworld_accessToken');\n  }\n\n  // 초기화\n  initUser(): void {\n    const accessToken = localStorage.getItem('loworld_accessToken');\n\n    if (!accessToken) {\n      return;\n    }\n\n    if (this.jwtHelper.isTokenExpired(accessToken)) {\n      console.log('JWT 토큰이 만료되었습니다.');\n      this.logout();\n      return;\n    }\n\n    try {\n      const decodedToken = this.jwtHelper.decodeToken(accessToken);\n      const user = decodedToken.payload as User;\n\n      if (user && user.id) {\n        this.user$.next(user);\n        console.log('[MembershipService] initUser() - user$ 업데이트 완료:', user);\n        \n        // userOrganizations이 있으면 selectedOrganization 설정\n        if (user.userOrganizations && user.userOrganizations.length > 0) {\n          this.selectedOrganization = user.userOrganizations[0];\n          this.organizationPermission = user.userPermission[0];\n        }\n      }\n    } catch (error) {\n      console.warn('토큰 디코딩 실패:', error);\n      this.logout();\n    }\n  }\n\n  decodeToken(accessToken: string): User {\n    const decodedToken = this.jwtHelper.decodeToken(accessToken);\n    return decodedToken.payload as User;\n  }\n\n  private checkStatus(): void {\n    this.user$.subscribe({\n      next: user => {\n        this._isLoggedIn = !!user.id;\n      }\n    });\n  }\n}\n"],
  "mappings": "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",
  "names": ["RoleId"]
}
